/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";

import jsPDF from "jspdf";
import { format } from "date-fns";

import type { OrderProps } from "@/types/order.types";
import "@/lib/fonts/Roboto-Regular-normal"; // регистрирует "Roboto-Regular"

type Mode = "download" | "preview";
type GenerateOptions = {
  sign?: boolean;
  signatureSrc?: string; // /public/... или dataURL
  stampSrc?: string; // /public/... или dataURL
  mode?: Mode;
};

/* -------------------- helpers: изображения -------------------- */
function loadHTMLImage(url: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = () => reject(new Error(`Image load failed: ${url}`));
    img.src = url;
  });
}
async function toPngDataURL(src?: string) {
  if (!src) return undefined;
  const url =
    src.startsWith("http") || src.startsWith("data:")
      ? src
      : `${window.location.origin}${src.startsWith("/") ? "" : "/"}${src}`;
  if (url.startsWith("data:image/png")) return url;
  const img = await loadHTMLImage(url);
  const canvas = document.createElement("canvas");
  canvas.width = img.naturalWidth || img.width;
  canvas.height = img.naturalHeight || img.height;
  const ctx = canvas.getContext("2d");
  if (!ctx) throw new Error("Canvas 2D context unavailable");
  ctx.drawImage(img, 0, 0);
  return canvas.toDataURL("image/png");
}
async function addImageSafe(
  doc: jsPDF,
  src: string | undefined,
  x: number,
  y: number,
  w: number,
  h: number
) {
  if (!src) return;
  try {
    const dataUrl = await toPngDataURL(src);
    if (!dataUrl) return;
    doc.addImage(dataUrl, "PNG", x, y, w, h, undefined, "FAST");
  } catch (e) {
    console.warn("addImageSafe failed:", e);
  }
}
async function addSquareImage(
  doc: jsPDF,
  src: string | undefined,
  x: number,
  y: number,
  sizeMM: number
) {
  if (!src) return;
  try {
    const url =
      src.startsWith("http") || src.startsWith("data:")
        ? src
        : `${window.location.origin}${src.startsWith("/") ? "" : "/"}${src}`;
    const img = await loadHTMLImage(url);
    const side = Math.min(img.naturalWidth, img.naturalHeight);
    const canvas = document.createElement("canvas");
    canvas.width = side;
    canvas.height = side;
    const ctx = canvas.getContext("2d");
    if (!ctx) throw new Error("Canvas 2D context unavailable");
    const dx = (img.naturalWidth - side) / 2;
    const dy = (img.naturalHeight - side) / 2;
    ctx.drawImage(img, dx, dy, side, side, 0, 0, side, side);
    const dataUrl = canvas.toDataURL("image/png");
    doc.addImage(dataUrl, "PNG", x, y, sizeMM, sizeMM, undefined, "FAST");
  } catch (e) {
    console.warn("addSquareImage failed:", e);
  }
}

/* -------------------- разметка текста -------------------- */
type PrintCtx = {
  doc: jsPDF;
  pageWidth: number;
  pageHeight: number;
  marginX: number;
  marginYTop: number;
  marginYBottom: number;
  y: number;
  lineH: number;
};
function ensurePage(ctx: PrintCtx, nextBlockHeight = 0) {
  if (ctx.y + nextBlockHeight <= ctx.pageHeight - ctx.marginYBottom) return;
  ctx.doc.addPage();
  ctx.y = ctx.marginYTop;
}
function p(ctx: PrintCtx, text: string, fontSize = 10, gap = 2) {
  const { doc, pageWidth, marginX, lineH } = ctx;
  doc.setFontSize(fontSize);
  const wrapped = doc.splitTextToSize(text, pageWidth - marginX * 2);
  const blockH = wrapped.length * (lineH - 1) + gap + 1;
  ensurePage(ctx, blockH);
  doc.text(wrapped, marginX, ctx.y);
  ctx.y += blockH;
}
function h(ctx: PrintCtx, title: string) {
  ctx.doc.setFont("Roboto-Regular", "bold");
  p(ctx, title, 11, 3);
  ctx.doc.setFont("Roboto-Regular", "normal");
}
function twoCols(ctx: PrintCtx, left: string[], right: string[]) {
  const { doc, pageWidth, marginX, lineH } = ctx;
  const gap = 8;
  const colW = (pageWidth - marginX * 2 - gap) / 2;
  doc.setFontSize(9);
  const maxRows = Math.max(left.length, right.length);
  for (let i = 0; i < maxRows; i++) {
    const L = left[i] ?? "";
    const R = right[i] ?? "";
    const wL = doc.splitTextToSize(L, colW);
    const wR = doc.splitTextToSize(R, colW);
    const rows = Math.max(wL.length, wR.length);
    const hgt = rows * (lineH - 1) + 1;
    ensurePage(ctx, hgt);
    doc.text(wL, marginX, ctx.y);
    doc.text(wR, marginX + colW + gap, ctx.y);
    ctx.y += hgt;
  }
  ctx.y += 3;
}

/* -------------------- ПОЛНЫЙ ТЕКСТ ДОГОВОРА -------------------- */
const COVER_TOP: string[] = [
  "Договор № _______________",
  "на оказание услуг по сервисному обслуживанию и ремонту техники",
];

const INTRO: string[] = [
  "г. Санкт-Петербург                                                                    «_____»_____________ 20__ г.",
  "_______________________________________________________________________________________ именуемый",
  'в дальнейшем "Заказчик", с одной стороны, и сервисный центр по обслуживанию и ремонту техники Общество с',
  'ограниченной ответственностью «Гарант», именуемый в дальнейшем "Исполнитель", в лице Генерального',
  "директора Беляева Егора Юрьевича, действующего на основании Устава, с другой стороны, в отдельности",
  "именуемые – Сторона, а при совместном упоминании – Стороны, заключили настоящий договор о",
  "нижеследующем:",
];

const S1 = {
  title: "1. ПРЕДМЕТ ДОГОВОРА",
  lines: [
    "1.1. В  рамках  настоящего  Договора  Исполнитель  обязуется  в  соответствии  с  заявками  Заказчика:",
    "  1.1.1. Принять принадлежащее Заказчику или его сотруднику единицу техники на  диагностику с целью",
    "выявления неисправности, и возможности его устранения, а также определения причины возникновения",
    "неисправности.",
    "  1.1.2. Осуществить работы по восстановлению работоспособности техники и устранения выявленных в процессе",
    "диагностики неисправностей своими силами, с применением собственного оборудования, материалов,",
    "инструментов (далее по тексту – «ремонт») и сдать их результат Заказчику.",
    "  Обязательства Исполнителя, предусмотренные пунктами 1.1.1 и 1.1.2 далее по тексту именуются «Работы».",
  ],
};

const S2 = {
  title: "2. ПОРЯДОК И ЦЕНА РЕМОНТА ТЕХНИКИ",
  lines: [
    "2.1. Ремонт техники осуществляется Исполнителем своими силами.",
    "2.2. Цена ремонта основывается на прейскуранте (Приложение 1) и согласовывается в каждом конкретном случае",
    "индивидуально. Заказчик ознакомлен с расценками оказываемых услуг Исполнителя и сними согласен.",
    "2.3. На все произведённые Работы выдаётся письменная гарантия от Исполнителя сроком от 30 до 365 дней. В",
    "случае если устранённая неисправность повторяется в течение гарантийного срока, и соблюдены гарантийные",
    "условия, Исполнитель обязан устранить неисправность бесплатно.",
    "2.4. Работы производятся на основании заявки (Приложение 2) от ответственных лиц Заказчика, поступаемых по",
    "средством телефонной связи, которые принимаются Исполнителем по указанным ниже телефонам с 9-00 до 21-00",
    "в рабочие дни и с 10-00 до 20-00 в выходные и праздничные дни. Заказчик сообщает марку, модель, тип техники,",
    "характер неисправности и другие сведения, которые Заказчик считает необходимым сообщить. Далее",
    "согласовывается способ передачи техники в ремонт: с адреса Заказчика или в сервисном центре Исполнителя.",
    "2.5. Доставка от Заказчика до ремонтной мастерской Исполнителя и обратно осуществляется силами и за счёт",
    "Исполнителя в случае нахождения единицы техники в пределах КАД.",
    "2.6. Приёмка техники в адресе Исполнителя осуществляется от доверенного лица Заказчика по адресу: Санкт-",
    "Петербург, Вознесенский проспект дом 55 Литер А.",
    "2.7. Диагностика неисправности осуществляется в срок от 1 до 7 рабочих дней. По истечении этого срока,",
    "Исполнитель извещает Заказчика в устной или письменной форме по средством электронной почты об",
    "обнаруженных неисправностях, перечне работ, которые надо осуществить, перечне деталей, подлежащих замене,",
    "а также окончательной цене Работ.",
    "2.8. В случае положительного решения Заказчика, Стороны подписывают дополнительное соглашение.",
    "2.9. После проверки произведённых Исполнителем Работ, Заказчик обязуется принять результат выполненных",
    "Работ и оплатить их, в срок не более 3-х рабочих дней.",
    "2.6. Заменённые детали остаются у Исполнителя либо передаются Заказчику по его требованию.",
  ],
};

const S3 = {
  title: "3. РАСЧЕТЫ ПО ДОГОВОРУ",
  lines: [
    "3.1. Оплата Работ по настоящему Договору производится Заказчиком по каждой заявке отдельно согласно",
    "дополнительному соглашению. Согласованные к оплате денежные суммы могут меняться в разные стороны в",
    "зависимости от проведённых и требуемых к выполнению работ.  Оплата услуг производится путём перечисления",
    "денежных средств на расчётный счёт Исполнителя или внесением наличных средств в кассу Исполнителя.",
    "3.2. В случае, когда невозможность исполнения возникла по обстоятельствам, за которые ни одна из Сторон не",
    "отвечает, Заказчик возмещает Исполнителю фактически понесённые им расходы.",
  ],
};

const S4 = {
  title: "4. ОТВЕТСТВЕННОСТЬ СТОРОН",
  lines: [
    "4.1. В случае неисполнения или ненадлежащего исполнения Исполнителем услуг по настоящему Договору он",
    "несёт ответственность в соответствии с действующим законодательством Российской Федерации.",
    "4.2. В случае неоплаты услуг Исполнителя в установленный настоящим Договором срок Заказчик уплачивает пени",
    "в размере 1% от причитающейся к оплате суммы за каждый день просрочки. Исполнитель должен направить",
    "Заказчику письменную претензию с указанием суммы задолженности и выражением своего намерения взыскать",
    "неустойку за просрочку оплаты.",
  ],
};

const S5 = {
  title: "5. СРОК ДЕЙСТВИЯ И УСЛОВИЯ РАСТОРЖЕНИЯ ДОГОВОРА",
  lines: [
    "5.1. Настоящий Договор вступает в силу с момента его подписания Сторонами и действует до исполнения работ,",
    "либо до момента досрочного расторжения в случаях, предусмотренных настоящим Договором и действующим",
    "законодательством Российской Федерации.",
    "5.2. Договор может быть досрочно расторгнут по соглашению Сторон.",
    "5.3. Заказчик вправе в одностороннем порядке отказаться от исполнения настоящего Договора с уведомлением",
    "Исполнителя не менее чем за 7 дней до момента расторжения. В таком случае Договор считается расторгнутым по",
    "истечении указанного срока при условии получения уведомления Исполнителем.",
    "5.4. В случае расторжения Договора Заказчиком в порядке, предусмотренном п. 5.3 настоящего Договора, он",
    "обязан оплатить услуги Исполнителя, согласованные до расторжения Договора.",
    "5.5. Исполнитель вправе в одностороннем порядке отказаться от исполнения настоящего Договора с уведомлением",
    "Заказчика не менее чем за 3 дня до момента расторжения, в случае просрочки оплаты со стороны Заказчика на",
    "срок более чем на 3 дня.",
    " ________________________________________________________________________________________________",
    "(Подпись,                   ФИО                полностью)",
  ],
};

const S6 = {
  title: "6. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ",
  lines: [
    "6.1. Исполнитель несёт полную материальную ответственность за сохранность техники переданной Заказчиком",
    "для диагностики и проведения Работ.",
    "6.2. Настоящий Договор составлен в двух экземплярах, имеющих одинаковую юридическую силу, по одному для",
    "каждой из Сторон.",
    "6.3. Все приложения к настоящему Договору являются его неотъемлемой частью.",
    "6.4. Во всем остальном, что не предусмотрено настоящим Договором, Стороны руководствуются действующим",
    "законодательством Российской Федерации.",
    "6.5. Все разногласия по данному Договору разрешаются путём переговоров. В случае невозможности решить",
    "спорные вопросы путём переговоров они передаются на рассмотрение в арбитражный суд г. Санкт-Петербурга.",
    "6.6. Цены за работы, указанные в настоящем Договоре, определены только для настоящего Договора и не могут",
    "служить прецедентом или конкурентным материалом при заключении аналогичных договоров в будущем.",
  ],
};

const S8_REQUISITES_LEFT = [
  "Исполнитель:",
  "ООО «ГАРАНТ»,",
  "Юр. адрес 188259, Россия, Ленинградская область,",
  "М. р-н Лужский,С.П. Скребловское, д. Калгановка,",
  "ул. Промышленная  дом 1 пом. 4,",
  "Фактич. Адрес: СПБ,, пр. Вознесенский дом 55 Литер А",
  "ИНН 4705097126, КПП 470501001, ОГРН 1224700017849.",
  "тел.: ______________________________",
];
const S8_REQUISITES_RIGHT = [
  "Заказчик:",
  "______________________________________________",
  "адрес__________________________________________",
  "_______________________________________________",
  "",
  "",
  "",
  "",
];

const SIGN_BLOCK = [
  "ПОДПИСИ СТОРОН:",
  "    Исполнитель:                                                                                                Заказчик:",
  "__________/___________                                                                        _____________/_____________",
];

const APP1_TITLE = "Приложение №1       Заявка на ремонт техники.";
const APP1_BODY: string[] = [
  "Дата приемки",
  "Тип заказа",
  "Тип техники",
  "Заявленный дефект",
  "Производитель/модель",
  "Внешний вид /комплектация",
  "Предоплата",
  "",
  "1. Заказчик сдал, а Исполнитель принял технику в состоянии и комплектности, указанной выше, для",
  "проведения диагностики с целью определения причин возникновения неисправностей, способов, сроков и стоимости их",
  "устранения. Стоимость диагностики составляет ___________________________ руб в случае отказа Заказчика от ремонта. Срок",
  "проведения диагностики не может превышать 10 (десять) рабочих дней. По окончании диагностики Исполнитель уведомляет",
  "Заказчика об окончательной стоимости, приблизительных сроках технического обслуживания и иных особенностях, связанных",
  "с устранением неисправности в технике Заказчика. В окончательную стоимость технического обслуживания включена,",
  "стоимость заменённых запасных частей, стоимость работ технического специалиста Исполнителя по устранению",
  "неисправности. Подтверждая сообщённую Исполнителем полную стоимость технического обслуживания, Заказчик выражает",
  "своё согласие на возмездное устранение неисправности согласно условиям настоящего Договора. Выражение воли Заказчика",
  "может быть подтверждено записью телефонного разговора, смс - сообщением, полученным с телефонного номера Заказчика,",
  "записью с камер видео наблюдения, расположенных в помещении Исполнителя при отказе Заказчика от дальнейшего",
  "обслуживания техники (к примеру, в случае несогласия с окончательной стоимостью, сроком обслуживания или отсутствия",
  "оригинальных деталей у Исполнителя), сумма, уплаченная за диагностику, не возвращается.",
  "2. Заказчик выражает своё согласие с тем, что в процессе технического обслуживания, техника может быть",
  "модернизирована, в том числе добавлен новый функционал, как путём обновления программного обеспечения (прошивки), так",
  "и путём замены электронных компонентов.",
  "3. Заказчик выражает своё согласие с тем, что при замене корпусных частей техники, они могут иметь незначительное",
  "отличие в оттенке от изначально сданных на техническое обслуживание.",
  "4. При не гарантийном техническом обслуживании сроки устранения неисправностей могут зависеть от количества и",
  "сложности неисправностей, а также от наличия необходимых деталей и от сроков поставки деталей Изготовителем. В любом",
  "случае окончательный срок технического обслуживания не может превышать 12 (двенадцати) месяца с момента сдачи",
  "Заказчиком техники на техническое обслуживание. возникают последствия, указанные в п. 8 настоящего Договора.",
  "5. Гарантийный срок на произведённые работы техническим специалистом и заменённые детали (запасные части)",
  "составляет - 45 календарных дней при условии соблюдения правил эксплуатации. Гарантийный срок не распространяется, если",
  "техника до передачи её на техническое обслуживание, было подвержено воздействию жидкости или платы имели механические",
  "или электрические повреждения. При необходимости заказа запчастей гарантийный срок ремонта  может быть продлён до 12",
  "месяцев.",
  "6. Исполнитель не несёт ответственность за принадлежности, комплектности и аксессуары, не указанные в настоящем",
  "документе при сдаче техники на гарантийное сервисное обслуживание, а также за повреждения аудио и видеокассет, компакт",
  "и мини дисков, карт памяти, связанные с их извлечением из неисправной техники.",
  "Исполнитель не несёт ответственности за сохранность информации на цифровых, медиа и других носителях переданной на",
  "сервисное обслуживание техники.",
  "7. Заказчик самостоятельно отслеживает окончание срока технического обслуживания по телефону +7 (812) 220-70-",
  "70. Если диагностика или техническое обслуживание завершены ранее срока, указанного в п. 1 и п. 5 настоящего договора или",
  "возникла необходимость продления срока, Заказчик может быть извещён по телефону, указанному в настоящем договоре или",
  "смс сообщением. В случае неясности информации или обнаружения пропущенного звонка с указанного номера телефона",
  "Заказчик обязуется перезвонить на номер +7 (812) 220-70-70 с целью уточнения информации о сданной технике. С момента",
  "окончания срока технического",
  "обслуживания, указанного в п. 5 настоящего договора или получением информации об её окончании указанными в настоящем",
  "пункте способами, Заказчик считается надлежаще извещённым о завершении технического обслуживания техники и",
  "готовности Исполнителя возвратить исправную технику. Окончание срока технического обслуживания обязывает Заказчика",
  "явиться по месту передачи техники Исполнителю либо иное место по согласованию. Исполнитель вправе, во время нахождения",
  "у него техники Заказчика, осуществлять телефонные звонки последнему с 10:00 до 20:00 без выходных с целью уточнения",
  "информации, имеющей значение для устранения недостатка.",
  "8. По истечении 7 дней со дня окончания технического обслуживания техники Заказчика, Исполнитель",
  "направляет технику на склад временного хранения. Подписав настоящее соглашение, Заказчик подтверждает, что он уведомлен",
  "о том, что по истечении 45 дней после извещения Заказчика о готовности заказа к выдаче, не явился к месту передачи техники",
  "к Исполнителю, техника не может быть выдана ему незамедлительно, а также согласен возместить Исполнителю расходы,",
  "понесённые им в связи с транспортировкой и хранением товара на складе временного хранения. По истечении 1 (одного) месяца",
  "хранения техники она подлежит утилизации.",
  "9. Заказчик самостоятельно несёт риски, связанные с предоставлением им недостоверных сведений",
  "Исполнителю, в том числе об адресе, номере телефона, и др. В случае утери Заказчиком своего экземпляра Договора, выдача",
  "техники производится при предъявлении паспорта лицом, передавшим технику Исполнителю на сервисное обслуживание. При",
  "несовпадении паспортных данных и данных, указанных Заказчиком в настоящем Договоре техника выдаче, не подлежит.",
  "10. Заказчик выражает своё согласие на обработку и использование средств автоматизации или без таковых",
  "своих персональных данных, указанных в Договоре и в иных представленных документах, в целях исполнения настоящего",
  "Договора. С указанными целями в отношении персональных данных будут совершаться такие действия, как сбор,",
  "систематизация, накопление, хранение, уточнение (обновление, изменение).",
  "",
  "Ориентировочная стоимость заказа _____________________________________________________________________________",
  "____________________________________________________________________________________________________________",
  "",
  "Принял:                        Сдал:",
];

const ADD_AGR_TITLE = "Дополнительное соглашение";
const ADD_AGR_BODY: string[] = [
  "По согласованию стоимости проведения необходимых работ и запчастей.",
  "",
  "Санкт-Петербург                                                            «___» ___________2025 год",
  "",
  "_______________________________________________________________________________________ именуемый",
  'в дальнейшем "Заказчик", с одной стороны, и сервисный центр по обслуживанию и ремонту техники Общество с',
  'ограниченной ответственностью «Гарант», именуемый в дальнейшем "Исполнитель", в лице Генерального',
  "директора Беляева Егора Юрьевича, действующего на основании Устава, с другой стороны, в отдельности",
  "именуемые – Сторона, а при совместном упоминании – Стороны, заключили настоящее дополнительное",
  "соглашение о нижеследующем:",
  "С целью проведения работ по договору на оказание услуг по сервисному обслуживанию и ремонту техники",
  "стороны по настоящему дополнительному соглашению договорились о ниже следующем:",
  "",
  "Стоимость проводимых работ составляет: ____________________________________________________________",
  "_________________________________________________________________________________________________",
  "_________________________________________________________________________________________________",
  "_________________________________________________________________________________________________",
  "_________________________________________________________________________________________________",
  "Заказчик ознакомлен со стоимостью работ и _______________________________________ с необходимостью",
  "заказа дополнительных запчастей и работой по её установке.",
  "Оплату работ Исполнителя Заказчик гарантирует.",
  "",
  "При необходимости заказа запасных частей, сроки проведения ремонтных работ предоставленной",
  "техники,  продлеваются на срок необходимый для приобретения и доставки согласованных с Заказчиком запасных",
  "частей .",
  "",
  "    Исполнитель:                                                                                                Заказчик:",
  "__________/___________                                                                  _____________/_____________",
];

/* const CONSENT_TITLE = "СОГЛАСИЕ\nна обработку персональных данных"; */
const CONSENT_BODY: string[] = [
  "Я, _____________________________________________________________________________",
  "(фамилия, имя, отчество - при наличии)",
  "даю свое согласие на обработку моих персональных данных, относящихся",
  "исключительно к перечисленным ниже категориям персональных данных: фамилия, имя,",
  "отчество; пол; дата рождения; тип документа, удостоверяющего личность; данные документа,",
  "удостоверяющего личность; гражданство; сведения об инвалидности и иные сведения.",
  "Я даю согласие на использование персональных данных исключительно в целях",
  "рассмотрения моих документов, а также на хранение данных об этих результатах",
  "на электронных носителях.",
  "Настоящее согласие предоставляется мной на осуществление действий в отношении",
  "моих персональных данных, которые необходимы для достижения указанных выше целей,",
  "включая (без ограничения) сбор, систематизацию, накопление, хранение, уточнение",
  "(обновление, изменение), использование, передачу третьим лицам для осуществления действий",
  "по обмену информацией, обезличивание, блокирование персональных данных,",
  "а также осуществление любых иных действий, предусмотренных действующим",
  "законодательством Российской Федерации.",
  "Я проинформирован, что получатель сведений гарантирует обработку моих",
  "персональных данных в соответствии с действующим законодательством Российской",
  "Федерации как неавтоматизированным, так и автоматизированным способами.",
  "Данное согласие действует до достижения целей обработки персональных данных",
  "или в течение срока хранения информации.",
  "Данное согласие может быть отозвано в любой момент по моему письменному",
  "заявлению.",
  "Я подтверждаю, что, давая такое согласие, я действую по собственной воле и в своих",
  "интересах.",
  "«___» ___________2025 г.",
  "",
  " /_____________________/ ________________________________",
  "          (Подпись)    (Расшифровка подписи)",
];

/* -------------------- normalize -------------------- */
function normalizeOrderLike(input: any) {
  const a = input?.attributes ?? {};
  return {
    number:
      input?.order_number ?? a?.order_number ?? input?.title ?? input?.id ?? "",
    client: {
      name: input?.client?.name ?? a?.client?.name ?? "",
      address: input?.client?.address ?? a?.client?.address ?? "",
      phone: input?.client?.phone ?? a?.client?.phone ?? "",
    },
  };
}

/* -------------------- GENERATOR -------------------- */
export async function generateContractPdf(
  order: OrderProps | any,
  opts: GenerateOptions = {}
) {
  const {
    sign = false,
    signatureSrc = "/images/sign.png",
    stampSrc = "/images/seal.png",
    mode = "download",
  } = opts;

  const o = normalizeOrderLike(order);
  const today = format(new Date(), "dd.MM.yyyy");

  const doc = new jsPDF({ unit: "mm", format: "a4" });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  const ctx: PrintCtx = {
    doc,
    pageWidth,
    pageHeight,
    marginX: 12,
    marginYTop: 15,
    marginYBottom: 15,
    y: 15,
    lineH: 6,
  };

  // базовые
  doc.setFont("Roboto-Regular");
  doc.setTextColor(0, 0, 0);

  /* ---------- HEADER ---------- */
  await addImageSafe(doc, "/images/logo.png", ctx.marginX, ctx.y, 38, 12);
  doc.setFontSize(8);
  const rightX = pageWidth - ctx.marginX - 70;
  [
    "ООО “Гарант”",
    "ИНН 4705097126",
    "КПП 470501001",
    "Адрес: г. Санкт-Петербург, Вознесенский проспект д. 55",
    "Телефон: 8 (812)–220 -70 -70",
    "spbgarant.ru",
  ].forEach((txt, i) => {
    doc.text(txt, rightX + 70, ctx.y + i * 5, { align: "right" });
  });
  ctx.y += 22;

  // титульные строки
  doc.setFontSize(12);
  doc.text(COVER_TOP[0], pageWidth / 2, ctx.y, { align: "center" });
  ctx.y += 7;
  doc.text(COVER_TOP[1], pageWidth / 2, ctx.y, { align: "center" });
  ctx.y += 10;

  // дата/город
  doc.setFontSize(10);
  p(ctx, `г. Санкт-Петербург                                  ${today}`);

  // вступление
  INTRO.forEach((line) => p(ctx, line));

  // Разделы 1–6
  [S1, S2, S3, S4, S5, S6].forEach((sec) => {
    h(ctx, sec.title);
    sec.lines.forEach((line) => p(ctx, line));
  });

  // 8. Реквизиты сторон (в исходнике раздел с номером 8)
  h(ctx, "8. РЕКВИЗИТЫ СТОРОН");
  twoCols(ctx, S8_REQUISITES_LEFT, S8_REQUISITES_RIGHT);

  // Подписи
  SIGN_BLOCK.forEach((line, i) => {
    if (i === 0) h(ctx, line);
    else p(ctx, line);
  });

  // печать+подпись
  if (sign) {
    await addSquareImage(doc, stampSrc, pageWidth / 2 - 20, ctx.y - 18, 40);
    await addImageSafe(
      doc,
      signatureSrc,
      pageWidth - ctx.marginX - 45,
      ctx.y - 20,
      45,
      45
    );
  }

  /* ---------- Приложение №1 ---------- */
  doc.addPage();
  ctx.y = ctx.marginYTop;
  h(ctx, APP1_TITLE);
  APP1_BODY.forEach((line) => p(ctx, line));

  /* ---------- Дополнительное соглашение ---------- */
  doc.addPage();
  ctx.y = ctx.marginYTop;
  h(ctx, ADD_AGR_TITLE);
  ADD_AGR_BODY.forEach((line) => p(ctx, line));

  /* ---------- Согласие на обработку ПДн ---------- */
  doc.addPage();
  ctx.y = ctx.marginYTop;
  // Заголовок из двух строк жирным
  doc.setFont("Roboto-Regular", "bold");
  p(ctx, "СОГЛАСИЕ", 12, 4);
  p(ctx, "на обработку персональных данных", 12, 6);
  doc.setFont("Roboto-Regular", "normal");
  CONSENT_BODY.forEach((line) => p(ctx, line));

  /* ---------- OUTPUT ---------- */
  const fileName = `Договор_${o.number || "без-номера"}_${today}.pdf`;
  if (mode === "preview") {
    const blob = doc.output("blob");
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank", "noopener,noreferrer");
    return;
  }
  doc.save(fileName);
}
